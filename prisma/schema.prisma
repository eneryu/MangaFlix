// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["referentialIntegrity"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  relationMode = "prisma"
}

enum Role {
  USER
  AUTHOR
  MODERATOR
  ADMIN
}

enum Status {
  ONGOING
  COMPLETED
  HIATUS
}

enum LibraryStatus {
  READING
  COMPLETED
  ON_HOLD
  DROPPED
  PLAN_TO_READ
}

enum SubscriptionTier {
  FREE
  PLUS
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email         String  @unique @db.VarChar(40)
  password      String  @db.VarChar(100)
  name          String  @db.VarChar(50)
  image         String? @db.VarChar(100)
  bio           String? @db.Text
  level         Int     @default(1)
  exp           Int     @default(0)
  maxExp        Int     @default(100)
  score         Int     @default(0)
  subscriptionTier SubscriptionTier @default(FREE)
  role          Role    @default(USER)

  mangas        Manga[]        @relation("MangaAuthor")
  comments      Comment[]
  libraryEntry  LibraryEntry[]
  likedMangas   MangaLike[]
  notifications Notification[]
  achievements  UserAchievement[]

  @@map("users")
}

model Manga {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  title       String   @db.VarChar(80)
  description String   @db.Text
  coverImage  String   @db.VarChar(100)
  status      Status   @default(ONGOING)
  views       Int      @default(0)
  rating      Float    @default(0)
  ratingsCount Int     @default(0)

  authorId String
  author   User   @relation("MangaAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  chapters     Chapter[]
  comments     Comment[]
  libraryEntry LibraryEntry[]
  likes        MangaLike[]
  genres       Genre[]       @relation("MangaGenres")
  ratings      Rating[]

  @@index([authorId])
  @@map("mangas")
}

model Chapter {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  number     Int
  title      String  @db.VarChar(80)
  pagesCount Int
  pages      ChapterPage[]
  views      Int       @default(0)
  
  mangaId String
  manga   Manga  @relation(fields: [mangaId], references: [id], onDelete: Cascade)

  @@index([mangaId])
  @@map("chapters")
}

model ChapterPage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  pageNumber Int
  imageUrl   String  @db.VarChar(100)

  chapterId String
  chapter   Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([chapterId])
  @@map("chapter_pages")
}

model Comment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  content String @db.Text
  likes   Int    @default(0)

  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  mangaId String
  manga   Manga  @relation(fields: [mangaId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([mangaId])
  @@map("comments")
}

model Rating {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  value   Int
  
  userId  String
  mangaId String
  manga   Manga  @relation(fields: [mangaId], references: [id], onDelete: Cascade)

  @@index([userId, mangaId])
  @@map("ratings")
}

model LibraryEntry {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  readStatus LibraryStatus @default(PLAN_TO_READ)

  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  mangaId String
  manga   Manga  @relation(fields: [mangaId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([mangaId])
  @@map("library_entries")
}

model MangaLike {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  mangaId String
  manga   Manga  @relation(fields: [mangaId], references: [id], onDelete: Cascade)

  @@index([userId, mangaId])
  @@map("manga_likes")
}

model Genre {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name   String @unique @db.VarChar(30)
  mangas Manga[] @relation("MangaGenres")

  @@map("genres")
}

model Achievement {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String  @unique @db.VarChar(30)
  description String  @db.Text
  imageUrl    String  @db.VarChar(100)
  points      Int     @default(0)
  
  users       UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId         String
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId  String
  achievement    Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@index([userId, achievementId])
  @@map("user_achievements")
}

model Notification {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  title   String  @db.VarChar(30)
  message String  @db.Text
  read    Boolean @default(false)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notifications")
} 